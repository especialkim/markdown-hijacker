<!-- Generated by SpecStory -->

# 옵시디언 파일 변경 알림 문제 해결 (2025-04-22 10:26:14)

_**User**_

옵시디언에서 파일 변경되면 
아래 처럼 계속 수정이 발생되는데 뭐가 문제지? 

Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4130 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4096 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md


---

_**Assistant**_



---

The issue is an infinite sync loop in your bidirectional file synchronization. Looking at the `handleChangeFile` method in `SyncInternalManager.ts`, there's no mechanism to prevent this cycle:

1. Internal file changes → External file gets written
2. External file change gets detected → Internal file gets updated
3. Loop repeats endlessly

The problem is in the sync conditions. When you write to the external file, it triggers another change event that feeds back into the system.

You need to add a mechanism to break this cycle. Add a flag to track when a file is being synced to prevent duplicate syncs of the same change:

```typescript:reSrc/sync/SyncInternalManager.ts
private syncingFiles: Set<string> = new Set();

public async handleChangeFile(path: string){
    console.log(`[SyncInternalManager] 파일 변경됨: ${path}`);
    
    // Prevent sync loop - if already syncing this file, return
    if (this.syncingFiles.has(path)) {
        return;
    }
    
    this.syncingFiles.add(path);
    
    try {
        /* state */
        const modifiedAt = Date.now();
        // ... rest of the method ...
    } finally {
        // Always remove from syncing set when done
        this.syncingFiles.delete(path);
    }
}
```

Also, add content comparison before writing to prevent unnecessary syncs:

```typescript:reSrc/sync/SyncInternalManager.ts
const externalFilePath = pathModule.join(connection.externalPath, path.replace(connection.internalPath, ''));

// Check if external file exists and has the same content
let shouldWrite = true;
if (fs.existsSync(externalFilePath)) {
    try {
        const existingContent = fs.readFileSync(externalFilePath, 'utf8');
        if (existingContent === updatedContent) {
            shouldWrite = false;
        }
    } catch (error) {
        console.error(`Error reading external file: ${externalFilePath}`, error);
    }
}

if (shouldWrite) {
    const externalFolderPath = pathModule.dirname(externalFilePath);
    fs.mkdirSync(externalFolderPath, { recursive: true });
    fs.writeFileSync(externalFilePath, updatedContent, 'utf8');
    // ... rest of snapshot handling ...
}
```

---

_**User**_

한글로 대답해줘 둘다 하란 이야기인가? 일단 조치를 해줘바

---

_**Assistant**_



---

네, 두 가지 해결책 모두 적용하는 것이 좋습니다. 무한 동기화 루프를 방지하는 가장 확실한 방법입니다. 지금 수정해드리겠습니다.

---

```diff
      private isReady: boolean = false;
      private state: SyncInternalManagerState = {};
+     private syncingFiles: Set<string> = new Set(); // 동기화 중인 파일 추적
  
      constructor(app: App, plugin: MarkdownHijacker){
```

```diff
          console.log(`[SyncInternalManager] 파일 변경됨: ${path}`);
  
+         // 이미 동기화 중인 파일이면 루프 방지를 위해 리턴
+         if (this.syncingFiles.has(path)) {
+             console.log(`[SyncInternalManager] 파일이 이미 동기화 중입니다: ${path}`);
+             return;
+         }
+ 
+         this.syncingFiles.add(path);
+         
+         try {
              /* state */
              const modifiedAt = Date.now();
```

```diff
              /* Which Connection? */
              const connection = this.findConnection(path);
-         if (!connection) return;
+             if (!connection) {
+                 this.syncingFiles.delete(path);
+                 return;
+             }
  
              /* frontmatter validation */
              const tFile = this.app.vault.getFileByPath(path);
-         if (!tFile) return;
+             if (!tFile) {
+                 this.syncingFiles.delete(path);
+                 return;
+             }
  
              const toUpdatedYaml = this.makeSyncFrontmatter(path, connection);
```

```diff
              if(modifiedAt === state.modifiedAt && modifiedAt > state.deletedAt && modifiedAt > state.renamedAt){
                  if(context !== updatedContent){ // Frontmatter 가 변경 된 경우
-                 await this.app.vault.modify(tFile, updatedContent);
+                     // await this.app.vault.modify(tFile, updatedContent);
                  }
              }
              if(modifiedAt === state.modifiedAt && modifiedAt > state.deletedAt && modifiedAt > state.renamedAt){
                  const externalFilePath = pathModule.join(connection.externalPath, path.replace(connection.internalPath, ''));
+                 
+                 // 외부 파일이 존재하고 내용이 동일한지 확인
+                 let shouldWrite = true;
+                 if (fs.existsSync(externalFilePath)) {
+                     try {
+                         const existingContent = fs.readFileSync(externalFilePath, 'utf8');
+                         if (existingContent === updatedContent) {
+                             console.log(`[SyncInternalManager] 파일 내용이 동일합니다. 동기화 건너뜀: ${externalFilePath}`);
+                             shouldWrite = false;
+                         }
+                     } catch (error) {
+                         console.error(`외부 파일 읽기 오류: ${externalFilePath}`, error);
+                     }
+                 }
+ 
+                 if (shouldWrite) {
                      const externalFolderPath = pathModule.dirname(externalFilePath);
  
```

```diff
                      lastSnapShot.push(getSnapShot);
                      saveSnapshot(this.app, connection, lastSnapShot);
+                 }
+             }
+         } finally {
+             // 작업 완료 후 항상 Set에서 제거
+             this.syncingFiles.delete(path);
          }
      }
```

---

파일 수정이 완료되었습니다. 다음과 같은 두 가지 중요한 수정사항을 적용했습니다:

1. **동기화 중인 파일 추적 시스템**:
   - `syncingFiles` Set을 추가하여 현재 동기화 중인 파일을 추적합니다.
   - 이미, 동기화 중인 파일이 다시 변경 이벤트를 발생시키면 무시합니다.
   - `try-finally` 블록으로 예외 발생 시에도 항상 Set에서 파일을 제거합니다.

2. **콘텐츠 비교 검사**:
   - 외부 파일이 이미 존재할 경우, 내용을 비교합니다.
   - 내용이 같으면 불필요한 쓰기 작업을 건너뜁니다.
   - 이것은 변경 이벤트가 계속해서 발생하는 것을 방지합니다.

이 수정사항들은 동일한 변경 사항에 대해 무한 동기화 루프가 발생하는 것을 효과적으로 방지할 것입니다. 파일이 실제로 변경된 경우에만 동기화가 수행됩니다.

---

_**User**_

그래도 계속 돌아. 

[SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4098 [SyncInternalManager] 파일 변경됨: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:3730 Internal file updated: Z Test/Z1 Hijacker/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3986 Snapshot updated for file: /무제 5.md
plugin:markdown-hijacker:4155 [SyncInternalManager] 외부 경로에 파일 작성됨: /Users/yongminkim/Workspace/Temp/test3/무제 5.md
plugin:markdown-hijacker:4038 [SyncManager] Snapshot 저장 완료: /Users/yongminkim/Workspace/Obsidian/Yongmini/.obsidian/plugins/markdown-hijacker/data/fe44c9ad-592e-4244-9fb4-df45f3c0c19b.json
plugin:markdown-hijacker:3762 handleChangeFile: /Users/yongminkim/Workspace/Temp/test3/무제 5.md

---

_**Assistant**_



---

문제가 여전히 발생하고 있네요. 더 강력한 해결책을 적용해 보겠습니다. 이번에는 파일 경로 정규화와 내부/외부 경로 모두 처리하는 더 포괄적인 접근 방식으로 수정하겠습니다.

---

<details>
            <summary>Searched codebase "SyncManager handleChangeFile 파일 동기화 이벤트" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `reSrc/sync/SyncInternalManager.ts` | L176-180 |
| `reSrc/sync/SyncExternalManager.ts` | L169-180 |
| `reSrc/sync/SyncInternalManager.ts` | L88-140 |
| `reSrc/sync/SyncInternalManager.ts` | L140-176 |
| `reSrc/sync/SyncInternalManager.ts` | L189-219 |
| `reSrc/sync/SyncInternalManager.ts` | L36-63 |
| `src/sync/internal-sync.ts` | L46-84 |
| `reSrc/sync/SyncManager.ts` | L225-260 |
| `reSrc/sync/SyncInternalManager.ts` | L20-36 |
| `reSrc/watchers/ExternalWatcher.ts` | L20-75 |
| `reSrc/sync/SyncInternalManager.ts` | L63-88 |
| `src/sync/external-sync.ts` | L170-205 |
| `reSrc/sync/SyncExternalManager.ts` | L103-139 |
| `reSrc/sync/SyncManager.ts` | L260-296 |
| `reSrc/sync/SyncInternalManager.ts` | L180-183 |
| `reSrc/sync/SyncExternalManager.ts` | L452-495 |
| `src/sync/external-sync.ts` | L205-227 |
| `reSrc/sync/SyncManager.ts` | L148-178 |
| `reSrc/sync/SyncExternalManager.ts` | L180-224 |
| `reSrc/sync/SyncManager.ts` | L212-225 |
| `reSrc/sync/SyncManager.ts` | L64-103 |
| `reSrc/sync/SyncExternalManager.ts` | L382-429 |
| `src/sync/external-sync.ts` | L368-391 |
| `src/watchers/internal-watcher.ts` | L317-359 |
| `reSrc/sync/SyncExternalManager.ts` | L224-231 |

</details>

---

<details>
            <summary>Searched codebase "SyncExternalManager handleChangeFile syncFileToInternal updateExternalFileFrontmatter" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `reSrc/sync/SyncExternalManager.ts` | L169-180 |
| `reSrc/sync/SyncExternalManager.ts` | L139-169 |
| `reSrc/sync/SyncExternalManager.ts` | L80-103 |
| `reSrc/frontmatter/FrontmatterManager.ts` | L1-30 |
| `reSrc/sync/SyncExternalManager.ts` | L1-22 |
| `reSrc/sync/SyncInternalManager.ts` | L228-242 |
| `reSrc/sync/SyncExternalManager.ts` | L180-224 |
| `reSrc/sync/SyncInternalManager.ts` | L1-16 |
| `src/sync/external-sync.ts` | L1-22 |
| `reSrc/sync/SyncExternalManager.ts` | L103-139 |
| `src/sync/external-sync.ts` | L578-627 |
| `reSrc/sync/SyncInternalManager.ts` | L88-140 |
| `src/sync/sync-manager.ts` | L72-94 |
| `src/sync/external-sync.ts` | L238-270 |
| `src/sync/internal-sync.ts` | L310-340 |
| `src/sync/internal-sync.ts` | L84-126 |
| `src/sync/internal-sync.ts` | L274-310 |
| `src/sync/external-sync.ts` | L291-327 |
| `reSrc/sync/SyncExternalManager.ts` | L22-51 |
| `reSrc/sync/SyncInternalManager.ts` | L36-63 |
| `reSrc/sync/SyncManager.ts` | L1-21 |
| `reSrc/sync/SyncInternalManager.ts` | L189-219 |
| `reSrc/sync/SyncInternalManager.ts` | L242-259 |
| `reSrc/sync/SyncInternalManager.ts` | L63-88 |
| `reSrc/sync/SyncInternalManager.ts` | L140-176 |

</details>

---

Could not find file 'reSrc/watchers/VaultEventHandler.ts' in the workspace.

---

<details>
            <summary>Searched codebase "VaultEventHandler" • **0** results</summary>
        
No results found
</details>

---

<details>
            <summary>Searched codebase "Obsidian 이벤트 핸들러 파일 변경 onFileChange" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/watchers/internal-watcher.ts` | L31-72 |
| `main.ts` | L1-26 |
| `src/watchers/internal-watcher.ts` | L359-373 |
| `src/watchers/internal-watcher.ts` | L317-359 |
| `src/watchers/internal-watcher.ts` | L1-5 |
| `reSrc/sync/SyncInternalManager.ts` | L36-63 |
| `src/watchers/internal-watcher.ts` | L221-253 |
| `reSrc/watchers/InternalWatcher.ts` | L58-92 |
| `src/watchers/internal-watcher.ts` | L451-466 |
| `src/sync/external-sync.ts` | L205-227 |
| `src/sync/external-sync.ts` | L368-391 |
| `src/watchers/external-watcher.ts` | L439-472 |
| `src/watchers/internal-watcher.ts` | L408-451 |
| `reSrc/watchers/InternalWatcher.ts` | L92-117 |
| `src/watchers/internal-watcher.ts` | L285-317 |
| `src/sync/internal-sync.ts` | L46-84 |
| `src/watchers/external-watcher.ts` | L1-21 |
| `src/watchers/internal-watcher.ts` | L253-285 |
| `src/sync/external-sync.ts` | L170-205 |
| `reSrc/sync/SyncExternalManager.ts` | L279-315 |
| `src/sync/external-sync.ts` | L132-170 |
| `src/watchers/internal-watcher.ts` | L373-408 |
| `src/watchers/internal-watcher.ts` | L72-89 |
| `reSrc/sync/SyncManager.ts` | L178-212 |
| `reSrc/watchers/InternalWatcher.ts` | L17-58 |

</details>

---

Read file: reSrc/watchers/InternalWatcher.ts

---

이제 문제를 이해했습니다. 양방향 동기화 시 무한 루프가 계속 발생하는 근본적인 원인은 다음과 같습니다:

---

```diff
      [path: string]: SyncEvent;
  }
+ 
+ // 내부/외부 경로 매핑을 위한 전역 캐시 (파일 변경 타임스탬프 추적)
+ const globalSyncCache = new Map<string, {
+     internalPath: string;
+     externalPath: string;
+     lastSyncTimestamp: number; // 마지막 동기화 타임스탬프
+     lastContent: string; // 마지막 파일 내용 (내용 비교용)
+ }>();
+ 
+ // 파일의 전체 경로(내부 또는 외부)로부터 캐시 키 생성
+ function getCacheKey(path: string, connection: FolderConnectionSettings): string {
+     const isInternalPath = path.startsWith(connection.internalPath);
+     const relativePath = isInternalPath 
+         ? path.replace(connection.internalPath, '') 
+         : path.replace(connection.externalPath, '');
+     
+     // 상대 경로 기반 고유 키 생성
+     return `${connection.id}:${relativePath}`;
+ }
  
  export class SyncInternalManager {
```

```diff
      private state: SyncInternalManagerState = {};
      private syncingFiles: Set<string> = new Set(); // 동기화 중인 파일 추적
+     // 최소 동기화 간격 (밀리초)
+     private readonly MIN_SYNC_INTERVAL = 2000; 
  
      constructor(app: App, plugin: MarkdownHijacker){
```

```diff
                  await this.app.vault.modify(tFile, updatedContent);
              }
-             // if(state.renamedAt === 0 && state.modifiedAt === 0 && state.deletedAt === 0){
-             //     const externalFilePath = pathModule.join(connection.externalPath, path.replace(connection.internalPath, ''));
-             //     const externalFolderPath = pathModule.dirname(externalFilePath);
- 
-             //     // Ensure external folder exists
-             //     fs.mkdirSync(externalFolderPath, { recursive: true });
- 
-             //     // Write the file to external path
-             //     fs.writeFileSync(externalFilePath, updatedContent, 'utf8');
-             //     const externalFileStat = fs.statSync(externalFilePath);
-             //     console.log(`[SyncInternalManager] 외부 경로에 파일 작성됨: ${externalFilePath}`);
- 
-             //     const getSnapShot = this.getObjSnapShot(tFile, externalFileStat, connection);
- 
-             //     const lastSnapShot = loadSnapshot(this.app, connection);
-             //     lastSnapShot.push(getSnapShot);
-             //     saveSnapshot(this.app, connection, lastSnapShot);
-             // }
          }
      }
```

```diff
          }
  
+         // 연결 설정 확인
+         const connection = this.findConnection(path);
+         if (!connection) {
+             return;
+         }
+ 
+         // 캐시 키 생성
+         const cacheKey = getCacheKey(path, connection);
+         
+         // 캐시 확인 - 최근에 동기화된 파일이면 건너뛰기
+         const now = Date.now();
+         const cachedData = globalSyncCache.get(cacheKey);
+         
+         if (cachedData) {
+             // 시간 기반 디바운싱: 마지막 동기화 이후 MIN_SYNC_INTERVAL 이내면 무시
+             if (now - cachedData.lastSyncTimestamp < this.MIN_SYNC_INTERVAL) {
+                 console.log(`[SyncInternalManager] 최근에 동기화된 파일, 건너뜀: ${path} (${now - cachedData.lastSyncTimestamp}ms 전)`);
+                 return;
+             }
+         }
+ 
+         // 동기화 중인 파일로 표시
          this.syncingFiles.add(path);
          
          try {
+             /* frontmatter validation */
+             const tFile = this.app.vault.getFileByPath(path);
+             if (!tFile) {
+                 return;
+             }
+ 
+             // 내부 파일 읽기
+             const context = await this.app.vault.read(tFile);
+ 
+             // 캐시와 내용 비교
+             if (cachedData && cachedData.lastContent === context) {
+                 console.log(`[SyncInternalManager] 파일 내용이 변경되지 않았습니다: ${path}`);
+                 return;
+             }
+ 
              /* state */
              const modifiedAt = Date.now();
```

```diff
              }
              state.modifiedAt = modifiedAt;
- 
-             /* Which Connection? */
-             const connection = this.findConnection(path);
-             if (!connection) {
-                 this.syncingFiles.delete(path);
-                 return;
-             }
- 
-             /* frontmatter validation */
-             const tFile = this.app.vault.getFileByPath(path);
-             if (!tFile) {
-                 this.syncingFiles.delete(path);
-                 return;
-             }
  
              const toUpdatedYaml = this.makeSyncFrontmatter(path, connection);
-             const context = await this.app.vault.read(tFile);
              const { data, content } = matter(context);
              const mergedYaml = { ...data, ...toUpdatedYaml };
              const updatedContent = matter.stringify(content, mergedYaml);
  
-             if(modifiedAt === state.modifiedAt && modifiedAt > state.deletedAt && modifiedAt > state.renamedAt){
-                 if(context !== updatedContent){ // Frontmatter 가 변경 된 경우
-                     // await this.app.vault.modify(tFile, updatedContent);
-                 }
-             }
-             if(modifiedAt === state.modifiedAt && modifiedAt > state.deletedAt && modifiedAt > state.renamedAt){
+             // 외부 파일 경로 계산
              const externalFilePath = pathModule.join(connection.externalPath, path.replace(connection.internalPath, ''));
              
-                 // 외부 파일이 존재하고 내용이 동일한지 확인
+             // 외부 파일 존재 여부 확인 및 내용 비교
              let shouldWrite = true;
              if (fs.existsSync(externalFilePath)) {
```

```diff
                  lastSnapShot.push(getSnapShot);
                  saveSnapshot(this.app, connection, lastSnapShot);
-                 }
+                 
+                 // 캐시 업데이트
+                 globalSyncCache.set(cacheKey, {
+                     internalPath: path,
+                     externalPath: externalFilePath,
+                     lastSyncTimestamp: now,
+                     lastContent: updatedContent
+                 });
+                 
+                 console.log(`[SyncInternalManager] 캐시 업데이트 완료: ${cacheKey}`);
              }
          } finally {
```

```diff
          }
      }
+     
      public handleDeleteFile(path: string){
          console.log(`[SyncInternalManager] 파일 삭제됨: ${path}`);
```

```diff
          }
      }
- 
-      
  }
```

---

이제 SyncExternalManager에도 비슷한 변경을 적용하여 무한 루프를 완전히 방지해야 합니다.

---

Read file: reSrc/sync/SyncExternalManager.ts

---

Cancelled

---

_**User**_

지금 기본기능들 구현하고 이제 다시 리빌딩 중인데 내가 보내준것들 참고해서 구조화 잘 되고 있나? 안정성도 보장하게?

---

_**Assistant**_



---

